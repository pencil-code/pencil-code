#!/bin/bash
#
# Known issues:
# - Information on which tests access a particular line is not displayed.
#
# 2025-Dec-09/Kishore: coded

set -e

help='''
Generate code coverage reports. Before running this script, pc_auto-test
should have been run with the --coverage flag. It is recommended to also use
the -C flag in case this is the first time you are generating code coverage
reports.

Example usage:
    pc_codecov --output-dir ~/public_html/pc_test/ -j 4 

Options:
    -h,--help               Show this help
    -H,--pencil-home        Location of the Pencil code (where pc_auto-test has
                            been run).
                            Default: $PENCIL_HOME
    -o,--output-dir         location in which to write the HTML output.
                            Default: ./lcov_html
    -j,--jobs               Number of parallel workers to use.
                            Default: 1
'''

# BEGIN option parsing
#https://stackoverflow.com/questions/192249/how-do-i-parse-command-line-arguments-in-bash/29754866#29754866
set -o errexit -o pipefail -o noclobber -o nounset

LONGOPTS=output-dir:,jobs:,pencil-home:,help
OPTIONS=o:j:H:h

PARSED=$(getopt --options=$OPTIONS --longoptions=$LONGOPTS --name "$0" -- "$@") || exit 2
eval set -- "$PARSED"

jobs=1
pencil_home="${PENCIL_HOME-}"
output_dir="./lcov_html"
while true; do
    case "$1" in
        -o|--output-dir)
            output_dir=$2
            shift 2
            ;;
        -j|--jobs)
            jobs=$2
            shift 2
            ;;
        -H|--pencil-home)
            pencil_home=$2
            shift 2
            ;;
        -h|--help)
            echo "$help"
            exit 0
            ;;
        --)
            shift
            break
            ;;
        *)
            echo "Error in parsing options"
            exit 3
            ;;
    esac
done
# END option parsing

if test -z "$pencil_home"; then
    echo "Error: you need to either specify --pencil-home, or define the environment variable PENCIL_HOME"
    exit 1
fi

if not test -e "$output_dir"; then
    mkdir -p "$output_dir"
fi

#clean up old files
find "$pencil_home"/samples -type f -name coverage.info -exec rm {} \;
find "$output_dir" -type f -exec rm {} \;

geninfo "$pencil_home"/samples -b "$pencil_home"/src -o "$output_dir"/pencil-codecov.info --ignore-errors inconsistent,inconsistent --filter missing --parallel "$jobs"

#NOTE: when I use --show-details, it fails with
# genhtml: ERROR: unexpected branch TLA UNC for count 0
genhtml --show-proportion --hierarchical --show-navigation --parallel "$jobs" --output-directory "$output_dir" "$output_dir"/pencil-codecov.info
